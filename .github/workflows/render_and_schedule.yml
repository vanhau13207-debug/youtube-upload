name: Auto Render & Schedule Upload (3 Times/Day)

on:
  workflow_dispatch:
  schedule:
    # Run 2 hours before upload time:
    # VN upload: 08:00, 16:00, 23:00
    # Run at: 06:00, 14:00, 21:00 VN
    # = 23:00, 7:00, 14:00 UTC
    - cron: "0 23,7,14 * * *"

jobs:
  build-and-run:
    runs-on: ubuntu-latest
    timeout-minutes: 300

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg libsndfile1

      - name: Install Python requirements
        run: |
          python -m pip install --upgrade pip
          pip install --no-cache-dir -r requirements_final.txt
          pip install google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client

      - name: Render full chill video + thumbnail + SEO
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          TARGET_DURATION: "7200"   # 2 hours
        run: |
          python workspace/allinone_gemini.py

      - name: Schedule upload on YouTube at correct VN time
        env:
          YT_CLIENT_ID: ${{ secrets.YT_CLIENT_ID }}
          YT_CLIENT_SECRET: ${{ secrets.YT_CLIENT_SECRET }}
          YT_REFRESH_TOKEN: ${{ secrets.YT_REFRESH_TOKEN }}
        run: |
          python workspace/schedule_upload.py

      - name: Upload backup artifacts
        uses: actions/upload-artifact@v4
        with:
          name: chill-output
          path: workspace/output/**
